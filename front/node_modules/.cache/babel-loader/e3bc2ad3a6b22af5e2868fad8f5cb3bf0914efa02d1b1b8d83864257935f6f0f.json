{"ast":null,"code":"const {\n  sql,\n  poolPromise\n} = require(\"../config/db\");\nconst fs = require('fs');\nconst path = require('path');\nconst submitFiles = async (req, res) => {\n  const {\n    userID,\n    complaintID,\n    createdBy\n  } = req.body;\n  const attachmentDoc = req.files && req.files['attachmentDoc'] ? req.files['attachmentDoc'][0].filename : null;\n  const userImage = req.files && req.files['userImage'] ? req.files['userImage'][0].filename : null;\n  let docUrl = null;\n  let imageUrl = null;\n  let docID = null;\n  let imageID = null;\n  try {\n    const pool = await poolPromise;\n\n    // Save the document locally and in the database\n    if (attachmentDoc) {\n      const docPath = path.join(__dirname, '..', 'uploads', attachmentDoc);\n      docUrl = `http://localhost:3000/uploads/${attachmentDoc}`;\n      const docResult = await pool.request().input(\"UserID\", sql.Int, userID).input(\"ComplaintID\", sql.Int, complaintID).input(\"DocUrl\", sql.NVarChar, docUrl).input(\"DocName\", sql.NVarChar, attachmentDoc).input(\"DocPath\", sql.NVarChar, docPath).input(\"DocSize\", sql.Int, fs.statSync(docPath).size).input(\"CreatedBy\", sql.NVarChar, createdBy).query(\"INSERT INTO ComplainDoc (UserID, ComplaintID, DocUrl, DocName, DocPath, DocSize, CreatedBy) OUTPUT INSERTED.DocID VALUES (@UserID, @ComplaintID, @DocUrl, @DocName, @DocPath, @DocSize, @CreatedBy)\");\n      if (docResult.recordset && docResult.recordset.length > 0) {\n        docID = docResult.recordset[0].DocID;\n        console.log('Document ID:', docID);\n      } else {\n        throw new Error(\"Failed to retrieve inserted document ID\");\n      }\n    }\n\n    // Save the image locally and in the database\n    if (userImage) {\n      const imagePath = path.join(__dirname, '..', 'uploads', userImage);\n      imageUrl = `http://localhost:3000/uploads/${userImage}`;\n      const imageResult = await pool.request().input(\"UserID\", sql.Int, userID).input(\"ComplaintID\", sql.Int, complaintID).input(\"ImageUrl\", sql.NVarChar, imageUrl).input(\"ImageName\", sql.NVarChar, userImage).input(\"ImagePath\", sql.NVarChar, imagePath).input(\"ImageSize\", sql.Int, fs.statSync(imagePath).size).input(\"CreatedBy\", sql.NVarChar, createdBy).query(\"INSERT INTO ComplainImage (UserID, ComplaintID, ImageUrl, ImageName, ImagePath, ImageSize, CreatedBy) OUTPUT INSERTED.ImageID VALUES (@UserID, @ComplaintID, @ImageUrl, @ImageName, @ImagePath, @ImageSize, @CreatedBy)\");\n      if (imageResult.recordset && imageResult.recordset.length > 0) {\n        imageID = imageResult.recordset[0].ImageID;\n        console.log('Image ID:', imageID);\n      } else {\n        throw new Error(\"Failed to retrieve inserted image ID\");\n      }\n    }\n    res.status(200).json({\n      success: true,\n      docID,\n      imageID\n    });\n  } catch (err) {\n    console.error('Error submitting files:', err.message);\n    res.status(500).json({\n      success: false,\n      message: \"Failed to submit files\",\n      error: err.message\n    });\n  }\n};\nmodule.exports = {\n  submitFiles\n};","map":{"version":3,"names":["sql","poolPromise","require","fs","path","submitFiles","req","res","userID","complaintID","createdBy","body","attachmentDoc","files","filename","userImage","docUrl","imageUrl","docID","imageID","pool","docPath","join","__dirname","docResult","request","input","Int","NVarChar","statSync","size","query","recordset","length","DocID","console","log","Error","imagePath","imageResult","ImageID","status","json","success","err","error","message","module","exports"],"sources":["C:/ComplainBHNA/front/src/components/complainSubmit.js"],"sourcesContent":["const { sql, poolPromise } = require(\"../config/db\");\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst submitFiles = async (req, res) => {\r\n  const { userID, complaintID, createdBy } = req.body;\r\n  const attachmentDoc = req.files && req.files['attachmentDoc'] ? req.files['attachmentDoc'][0].filename : null;\r\n  const userImage = req.files && req.files['userImage'] ? req.files['userImage'][0].filename : null;\r\n\r\n  let docUrl = null;\r\n  let imageUrl = null;\r\n  let docID = null;\r\n  let imageID = null;\r\n\r\n  try {\r\n    const pool = await poolPromise;\r\n\r\n    // Save the document locally and in the database\r\n    if (attachmentDoc) {\r\n      const docPath = path.join(__dirname, '..', 'uploads', attachmentDoc);\r\n      docUrl = `http://localhost:3000/uploads/${attachmentDoc}`;\r\n\r\n      const docResult = await pool\r\n        .request()\r\n        .input(\"UserID\", sql.Int, userID)\r\n        .input(\"ComplaintID\", sql.Int, complaintID)\r\n        .input(\"DocUrl\", sql.NVarChar, docUrl)\r\n        .input(\"DocName\", sql.NVarChar, attachmentDoc)\r\n        .input(\"DocPath\", sql.NVarChar, docPath)\r\n        .input(\"DocSize\", sql.Int, fs.statSync(docPath).size)\r\n        .input(\"CreatedBy\", sql.NVarChar, createdBy)\r\n        .query(\r\n          \"INSERT INTO ComplainDoc (UserID, ComplaintID, DocUrl, DocName, DocPath, DocSize, CreatedBy) OUTPUT INSERTED.DocID VALUES (@UserID, @ComplaintID, @DocUrl, @DocName, @DocPath, @DocSize, @CreatedBy)\"\r\n        );\r\n\r\n      if (docResult.recordset && docResult.recordset.length > 0) {\r\n        docID = docResult.recordset[0].DocID;\r\n        console.log('Document ID:', docID);\r\n      } else {\r\n        throw new Error(\"Failed to retrieve inserted document ID\");\r\n      }\r\n    }\r\n\r\n    // Save the image locally and in the database\r\n    if (userImage) {\r\n      const imagePath = path.join(__dirname, '..', 'uploads', userImage);\r\n      imageUrl = `http://localhost:3000/uploads/${userImage}`;\r\n\r\n      const imageResult = await pool\r\n        .request()\r\n        .input(\"UserID\", sql.Int, userID)\r\n        .input(\"ComplaintID\", sql.Int, complaintID)\r\n        .input(\"ImageUrl\", sql.NVarChar, imageUrl)\r\n        .input(\"ImageName\", sql.NVarChar, userImage)\r\n        .input(\"ImagePath\", sql.NVarChar, imagePath)\r\n        .input(\"ImageSize\", sql.Int, fs.statSync(imagePath).size)\r\n        .input(\"CreatedBy\", sql.NVarChar, createdBy)\r\n        .query(\r\n          \"INSERT INTO ComplainImage (UserID, ComplaintID, ImageUrl, ImageName, ImagePath, ImageSize, CreatedBy) OUTPUT INSERTED.ImageID VALUES (@UserID, @ComplaintID, @ImageUrl, @ImageName, @ImagePath, @ImageSize, @CreatedBy)\"\r\n        );\r\n\r\n      if (imageResult.recordset && imageResult.recordset.length > 0) {\r\n        imageID = imageResult.recordset[0].ImageID;\r\n        console.log('Image ID:', imageID);\r\n      } else {\r\n        throw new Error(\"Failed to retrieve inserted image ID\");\r\n      }\r\n    }\r\n\r\n    res.status(200).json({ success: true, docID, imageID });\r\n  } catch (err) {\r\n    console.error('Error submitting files:', err.message);\r\n    res.status(500).json({ success: false, message: \"Failed to submit files\", error: err.message });\r\n  }\r\n};\r\n\r\nmodule.exports = {\r\n  submitFiles,\r\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}